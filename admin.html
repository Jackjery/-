<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据管理中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 页面内容保持不变，重点修改文件上传相关的JavaScript -->
    
    <script>
        // 其他代码保持不变，重点修改handleFileUpload函数
        
        // 处理文件上传
        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 重置状态区域
            importStatus.classList.add('hidden');
            validationErrors.classList.add('hidden');
            hideGlobalError();
            
            // 基本验证文件大小（限制10MB）
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showStatus(`文件过大（${formatFileSize(file.size)}），请上传小于10MB的文件`, 'error');
                return;
            }
            
            showStatus(`正在处理文件: ${file.name}（${formatFileSize(file.size)}）`);
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // 显示处理进度
                        showStatus('正在解析Excel文件...');
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        let jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // 显示解析结果
                        showStatus(`文件解析完成，共发现 ${jsonData.length} 条记录`);
                        
                        // 数据验证和清洗
                        const { validRecords, invalidRecords } = validateAndCleanData(jsonData);
                        
                        // 显示验证结果
                        if (invalidRecords.length > 0) {
                            showValidationErrors(invalidRecords);
                        }
                        
                        if (validRecords.length === 0) {
                            showStatus('没有有效的记录可导入', 'error');
                            return;
                        }
                        
                        // 准备上传数据
                        const uploadData = { records: validRecords };
                        const jsonSize = new TextEncoder().encode(JSON.stringify(uploadData)).length;
                        
                        showStatus(
                            `准备上传 ${validRecords.length} 条有效记录（数据大小: ${formatFileSize(jsonSize)}），正在连接服务器...`
                        );
                        
                        // 记录上传开始时间
                        const uploadStartTime = Date.now();
                        
                        // 上传数据到服务器
                        const response = await fetch('/api/import', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(uploadData),
                            // 增加超时设置（30秒）
                            signal: AbortSignal.timeout(30000)
                        });
                        
                        // 计算上传耗时
                        const uploadTime = Math.round((Date.now() - uploadStartTime) / 1000);
                        
                        // 检查HTTP状态
                        if (!response.ok) {
                            // 尝试解析错误响应
                            let errorData;
                            try {
                                errorData = await response.json();
                            } catch (parseError) {
                                // 如果无法解析JSON，获取原始文本
                                const errorText = await response.text().catch(() => '无法获取错误详情');
                                throw new Error(`服务器返回错误 (${response.status}): ${errorText}`, {
                                    cause: { status: response.status, text: errorText }
                                });
                            }
                            
                            // 抛出结构化错误
                            throw new Error(
                                errorData.error || `上传失败 (${response.status})`, 
                                { cause: { ...errorData, status: response.status, uploadTime } }
                            );
                        }
                        
                        // 解析成功响应
                        const result = await response.json();
                        
                        if (result.success) {
                            showStatus(
                                `上传成功！耗时 ${uploadTime}秒，成功导入 ${result.inserted}/${result.total} 条记录`, 
                                'success'
                            );
                            
                            // 刷新数据列表
                            loadData();
                            
                            // 显示导入错误详情（如果有）
                            if (result.errors && result.errors.length > 0) {
                                setTimeout(() => {
                                    showImportErrorsDetails(result.errors);
                                }, 1000);
                            }
                        } else {
                            showStatus(`上传失败: ${result.error || '未知错误'}`, 'error');
                        }
                    } catch (error) {
                        console.error('文件处理错误:', error);
                        
                        // 显示详细错误信息
                        let errorMessage = error.message;
                        if (error.cause) {
                            if (error.cause.status === 401) {
                                errorMessage += '，请重新登录';
                                // 自动登出
                                setTimeout(() => {
                                    localStorage.removeItem('token');
                                    window.location.href = '/login.html';
                                }, 3000);
                            } else if (error.cause.status === 408 || error.name === 'TimeoutError') {
                                errorMessage = '上传超时，请尝试 smaller 文件或稍后重试';
                            } else if (error.cause.details) {
                                errorMessage += `（详情: ${error.cause.details}）`;
                            }
                        }
                        
                        showStatus(`处理文件失败: ${errorMessage}`, 'error');
                        showGlobalError(errorMessage, error.cause?.stack);
                    }
                };
                
                // 处理文件读取错误
                reader.onerror = (error) => {
                    console.error('文件读取错误:', error);
                    showStatus(`文件读取失败: ${error.message || '未知错误'}`, 'error');
                };
                
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('上传初始化错误:', error);
                showStatus(`上传准备失败: ${error.message}`, 'error');
            }
        }
        
        // 辅助函数：格式化文件大小
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        // 显示导入错误详情
        function showImportErrorsDetails(errors) {
            const errorDetails = errors.map(err => 
                `第 ${err.index + 1} 条: ${err.error}`
            ).join('\n');
            
            alert(`部分记录导入失败:\n\n${errorDetails}\n\n请检查这些记录后重新尝试`);
        }
        
        // 其他函数保持不变...
    </script>
</body>
</html>
    
